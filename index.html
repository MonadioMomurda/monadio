<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monadio Momurda Cartel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body { height: 100%; overflow-x: hidden; }

    body {
      min-height: 100vh;
      background: #000 url("bg.png") center center / cover fixed no-repeat;
      font-family: "JetBrains Mono","Fira Code","SF Mono","Roboto Mono",monospace;
      color: #fff;
    }

    /* ---------- HERO ---------- */

    .hero-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      padding-inline: 1rem;
      width: 100%;
    }

    .hero {
      position: relative;
      height: 100vh;
      max-width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .hero-img {
      height: 100%;
      width: auto;
      max-width: 100%;
      display: block;
      mix-blend-mode: screen;
    }

    .nav-links {
      position: absolute;
      left: 10%;
      bottom: 14%;
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      z-index: 5;
    }

    .nav-links a {
      text-decoration: none;
      font-size: 4.5rem;
      font-weight: 700;
      color: rgba(202,160,255,0.95);
      letter-spacing: 0.06em;
      text-shadow:
        0 0 10px #b154ff,
        0 0 22px #a442ff,
        0 0 36px #9025ff;
      transition: transform .15s ease, text-shadow .15s ease;
    }

    .nav-links a::before { content: "> "; }

    .nav-links a:hover {
      transform: translateX(8px);
      text-shadow:
        0 0 12px #b154ff,
        0 0 26px #a442ff,
        0 0 42px #9025ff,
        0 0 60px #7a0aff;
    }

    /* ---------- NFT PREVIEW WINDOW ---------- */

    .nft-preview-window {
      position: absolute;
      top: 7%;
      right: -25%;
      z-index: 4;
      width: min(26vw, 360px);
      max-width: 360px;
      pointer-events: auto;
    }

    .nft-preview-inner {
      position: relative;
      background: #111;
      border: 3px solid #e4d4ff;
      padding: 6px;
      box-shadow:
        0 0 18px rgba(186,132,255,0.9),
        0 0 42px rgba(152,90,255,0.9);
    }

    .nft-preview-window::before,
    .nft-preview-window::after {
      content: "";
      position: absolute;
      inset: -6px -6px auto auto;
      border: 3px solid #e4d4ff;
      opacity: 0.9;
    }

    .nft-preview-window::before {
      transform: translate(6px, -6px);
    }

    .nft-preview-window::after {
      transform: translate(12px, -12px);
    }

    .nft-preview-titlebar {
      height: 28px;
      background: #a66bff;
      border-bottom: 2px solid #e4d4ff;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-inline: 10px;
      font-size: 0.8rem;
      letter-spacing: .08em;
    }

    .nft-preview-titlebar::after {
      content: "–";
    }

    #nftPreview {
      width: 100%;
      display: block;
      background: #111;
      image-rendering: pixelated;
      border-top: 0;
      border: 2px solid #e4d4ff;
      border-top: none;
      transition:
        opacity .35s ease-out,
        filter .35s ease-out;
    }

    .nft-preview-inner.dissolve #nftPreview {
      opacity: 0;
      filter: blur(4px);
    }

    .nft-preview-hint {
      margin-top: 6px;
      font-size: 0.7rem;
      letter-spacing: .12em;
      text-align: center;
      opacity: 0.7;
    }

    .nft-preview-hint::before {
      content: "> ";
    }

    /* ===== MOBILE LAYOUT FIXES ===== */
    @media (max-width: 900px) {
      .hero {
        height: auto;
        width: 100vw;
        display: block;
      }

      .hero-img {
        width: 100vw;
        height: auto;
      }

      /* make nav flow *above* the preview window instead of absolute over it */
      .nav-links {
        position: static;
        left: auto;
        bottom: auto;
        margin: 1.8rem 0 0 8%;
        gap: 0.9rem;
      }

      .nav-links a {
        font-size: 2.4rem;
      }

      /* preview window becomes a centered block under the nav */
      .nft-preview-window {
        position: static;
        width: 82vw;
        max-width: 82vw;
        margin: 1.5rem auto 0;
      }
    }

    @media (max-width: 600px) {
      .nav-links {
        margin-left: 7%;
        margin-top: 1.6rem;
        gap: 0.7rem;
      }

      .nav-links a {
        font-size: 2rem;
      }

      .nft-preview-window {
        width: 86vw;
      }
    }

    /* ---------- MINT POPUP ---------- */

    .mint-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(3px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10; /* WalletConnect modal uses a higher z-index */
    }

    .mint-popup {
      width: 92%;
      max-width: 480px;
      background: #050505;
      border-radius: 12px;
      border: 2px solid rgba(202,160,255,0.5);
      box-shadow:
        0 0 30px rgba(202,160,255,0.7),
        0 0 60px rgba(100,40,150,0.8);
      padding: 2rem;
      position: relative;
      text-align: center;
    }

    .popup-title {
      font-size: 2rem;
      letter-spacing: 0.15em;
      color: #f7e8ff;
      margin-bottom: 0.6rem;
    }

    .popup-sub {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 2rem;
    }

    .close-popup {
      position: absolute;
      top: 12px;
      right: 16px;
      font-size: 1.6rem;
      cursor: pointer;
      color: #d9b3ff;
      text-shadow: 0 0 10px rgba(202,160,255,1);
    }

    .popup-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.3rem;
    }

    .popup-label {
      font-size: 1rem;
      letter-spacing: .08em;
    }

    .amount-controls {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .amount-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid rgba(200,150,255,0.9);
      background: transparent;
      color: #e6d1ff;
      cursor: pointer;
      font-size: 1.3rem;
      transition: 0.1s ease;
    }

    .amount-btn:hover {
      background: rgba(200,150,255,0.18);
      transform: translateY(-1px);
    }

    .amount-value {
      min-width: 34px;
      text-align: center;
      font-size: 1.3rem;
    }

    .button-primary {
      width: 100%;
      border-radius: 999px;
      padding: 0.9rem;
      border: 1px solid rgba(200,150,255,0.9);
      background: linear-gradient(135deg,#b365ff,#ff9dff);
      color: #100017;
      font-weight: 700;
      letter-spacing: 0.12em;
      cursor: pointer;
      text-transform: uppercase;
      box-shadow: 0 0 16px rgba(200,150,255,0.35);
      margin-top: 0.7rem;
      font-size: 0.86rem;
    }

    .button-primary:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .connect-btn {
      background: transparent;
      color: #d9c0ff;
    }

    .wl-btn {
      background: #120019;
      border-style: dashed;
      color: #f5d8ff !important;
      text-shadow:
        0 0 10px #b154ff,
        0 0 20px #a442ff;
    }

    .mint-status {
      margin-top: 1rem;
      min-height: 1.2rem;
      font-size: 0.85rem;
    }

    .mint-status.error   { color: #ff8f9a; }
    .mint-status.success { color: #9bffb5; }

    .contract-line {
      margin-top: 0.6rem;
      font-size: 0.75rem;
      opacity: 0.75;
    }

    .contract-line a {
      color: #caa0ff;
      text-decoration: underline;
    }

    /* ---------- BOTTOM ASCII MINT STATS ---------- */

    .mint-stats-box {
      position: fixed;
      left: 50%;
      bottom: 5%;
      transform: translateX(-50%);
      padding: 0.7rem 1.2rem;
      border: 2px solid #b154ff;
      border-radius: 4px;
      background: transparent;
      box-shadow:
        0 0 12px rgba(177,84,255,0.9),
        0 0 28px rgba(122,10,255,0.7);
      z-index: 6;
      max-width: 90vw;
    }

    .mint-stats-line {
      font-size: 1.1rem;
      font-weight: 700;
      color: rgba(202,160,255,0.95);
      letter-spacing: 0.12em;
      text-shadow:
        0 0 8px #b154ff,
        0 0 18px #a442ff,
        0 0 26px #9025ff;
      white-space: nowrap;
    }

    .mint-stats-line + .mint-stats-line {
      margin-top: 0.15rem;
    }

    @media (max-width: 600px) {
      .mint-stats-box {
        bottom: 3%;
        padding: 0.5rem 0.9rem;
      }
      .mint-stats-line {
        font-size: 0.9rem;
        letter-spacing: 0.08em;
      }
    }
  </style>
</head>

<body>

<body>

<section class="hero-wrapper">
  <div class="hero">
    <img src="main.png" class="hero-img" alt="Monadio Momurda Cartel">

    <nav class="nav-links">
      <a href="#" id="openMint">MINT</a>
      <a href="https://x.com/MonadioMomurda" target="_blank">TWITTER</a>
      <a href="https://t.me/monadiocartel" target="_blank">CHAT</a>
      <a href="https://monadio.club" target="_blank">CHECK PRICE</a>
    </nav>

    <!-- NFT PREVIEW WINDOW -->
    <div class="nft-preview-window" id="nftPreviewWindow">
      <div class="nft-preview-inner" id="nftPreviewInner">
        <div class="nft-preview-titlebar"></div>
        <img
          id="nftPreview"
          src="nft_prereveal.png"
          alt="Monadio NFT preview"
        />
      </div>
      <div class="nft-preview-hint">
        hover / tap to reveal
      </div>
    </div>
  </div>
</section>

<div class="mint-overlay" id="mintOverlay">
  <div class="mint-popup">
    <div class="close-popup" id="closeMint">×</div>

    <div class="popup-title">MINT</div>
    <div class="popup-sub">CONNECT WALLET AND CHOOSE AMOUNT</div>

    <div class="popup-row">
      <span class="popup-label">AMOUNT</span>
      <div class="amount-controls">
        <button class="amount-btn" id="minusBtn">−</button>
        <span class="amount-value" id="mintAmount">1</span>
        <button class="amount-btn" id="plusBtn">+</button>
      </div>
    </div>

    <div class="popup-row">
      <span class="popup-label">TOTAL</span>
      <span id="totalPrice">1111.0000 MON</span>
    </div>

    <div class="popup-row">
      <span class="popup-label">WALLET</span>
      <span id="walletAddr">NOT CONNECTED</span>
    </div>

    <button class="button-primary connect-btn" id="connectWallet">CONNECT</button>
    <button class="button-primary" id="mintNow" disabled>MINT NOW</button>
    <button class="button-primary wl-btn" id="freeMintBtn" disabled>CLAIM AIRDROP</button>

    <div class="contract-line">
      CONTRACT:
      <a href="https://monadvision.com/address/0xba26bA63d31D284095F38f0B107DE802e1268Fcf"
         target="_blank">0xba26...8Fcf</a>
    </div>

    <div class="mint-status" id="mintStatus"></div>
  </div>
</div>

<!-- BOTTOM ASCII MINT STATS BOX -->
<div class="mint-stats-box">
  <div class="mint-stats-line" id="mintedText">>0/1111 MINTED</div>
  <div class="mint-stats-line" id="barText">>[........................]</div>
</div>

<!-- WalletConnect Ethereum Provider -->
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.10.0/dist/index.umd.js"></script>
<!-- ethers.js -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
  // ====== CONFIG ======
  const CONTRACT_ADDRESS = "0xba26bA63d31D284095F38f0B107DE802e1268Fcf";

  const CONTRACT_ABI = [
    "function mint(uint256 _mintAmount) payable",
    "function cost() view returns (uint256)",
    "function freeMint() external",
    "function totalSupply() view returns (uint256)",
    "function maxSupply() view returns (uint256)"
  ];

  // Fallback so any stray references don't explode
  let accounts = [];

  const MONAD_CHAIN_ID_HEX = "0x8f"; // 143 mainnet
  const MONAD_PARAMS = {
    chainId: MONAD_CHAIN_ID_HEX,
    chainName: "Monad Mainnet",
    nativeCurrency: { name: "Monad", symbol: "MON", decimals: 18 },
    rpcUrls: ["https://rpc.monad.xyz"],
    blockExplorerUrls: ["https://monadvision.com"]
  };

  const FALLBACK_COST_MON = "1111";
  const MINT_MAX_FALLBACK = 1111;   // used if maxSupply() fails
  const BAR_LENGTH        = 24;     // characters between [ and ]

  // Detect Phantom mobile browser environment
  function isPhantomMobile() {
    return (
      /phantom/i.test(navigator.userAgent) &&
      window.ethereum &&
      window.ethereum.isPhantom
    );
  }

  // ====== POPUP ======
  const openMint  = document.getElementById("openMint");
  const closeMint = document.getElementById("closeMint");
  const overlay   = document.getElementById("mintOverlay");

  openMint.addEventListener("click", (e) => {
    e.preventDefault();
    overlay.style.display = "flex";
  });
  closeMint.addEventListener("click", () => { overlay.style.display = "none"; });
  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) overlay.style.display = "none";
  });

  // ====== PROVIDERS ======
  let injectedProvider      = null;
  let walletConnectProvider = null;
  let activeProvider        = null;

  function detectInjectedProvider() {
    const eth = window.ethereum;
    if (!eth) return null;

    if (eth.providers && eth.providers.length) {
      const metaMask = eth.providers.find(p => p.isMetaMask);
      if (metaMask) return metaMask;
      const trust = eth.providers.find(p => p.isTrust || p.isTrustWallet);
      if (trust) return trust;
      return eth.providers[0];
    }
    return eth;
  }

  function getActiveProvider() {
    return activeProvider;
  }

  async function getWalletConnectProvider() {
    if (walletConnectProvider) return walletConnectProvider;

    const wcModule = window["@walletconnect/ethereum-provider"];
    if (!wcModule || !wcModule.EthereumProvider) {
      throw new Error("WalletConnect provider script not loaded");
    }

    walletConnectProvider = await wcModule.EthereumProvider.init({
      projectId: "a76907beadb483551f410ad4716c28f3", // your WC projectId
      chains: [143],
      optionalChains: [143],
      rpcMap: { 143: "https://rpc.monad.xyz" },
      methods: [
        "eth_sendTransaction",
        "personal_sign",
        "eth_signTypedData",
        "wallet_switchEthereumChain",
        "wallet_addEthereumChain"
      ],
      events: ["chainChanged", "accountsChanged"],
      metadata: {
        name: "Monadio Mint",
        description: "Monadio Momurda Cartel Mint",
        url: window.location.origin,
        icons: ["https://monadio.club/main.png"]
      },
      showQrModal: true
    });

    return walletConnectProvider;
  }

  // ====== STATE + UI ======
  let amount = 1;
  const MAX_AMOUNT = 11;
  let costWei = ethers.utils.parseEther(FALLBACK_COST_MON);
  let currentAccount = null;

  const plusBtn     = document.getElementById("plusBtn");
  const minusBtn    = document.getElementById("minusBtn");
  const amountEl    = document.getElementById("mintAmount");
  const priceEl     = document.getElementById("totalPrice");
  const walletEl    = document.getElementById("walletAddr");
  const statusEl    = document.getElementById("mintStatus");
  const connectBtn  = document.getElementById("connectWallet");
  const mintBtn     = document.getElementById("mintNow");
  const freeMintBtn = document.getElementById("freeMintBtn");

  const mintedTextEl = document.getElementById("mintedText");
  const barTextEl    = document.getElementById("barText");

  function setStatus(msg, type = "") {
    statusEl.textContent = msg;
    statusEl.className = "mint-status" + (type ? " " + type : "");
  }

  function updatePrice() {
    const totalWei = costWei.mul(amount);
    const formatted = ethers.utils.formatEther(totalWei);
    priceEl.textContent = parseFloat(formatted).toFixed(4) + " MON";
  }

  function setAmount(newAmount) {
    if (newAmount < 1) newAmount = 1;
    if (newAmount > MAX_AMOUNT) newAmount = MAX_AMOUNT;
    amount = newAmount;
    amountEl.textContent = amount;
    updatePrice();
  }

  plusBtn.addEventListener("click", () => setAmount(amount + 1));
  minusBtn.addEventListener("click", () => setAmount(amount - 1));
  updatePrice();

  function handleAccountsChanged(accs) {
    if (!accs || !accs.length) {
      currentAccount = null;
      walletEl.textContent = "NOT CONNECTED";
      mintBtn.disabled = true;
      freeMintBtn.disabled = true;
      connectBtn.textContent = "CONNECT";
    } else {
      currentAccount = accs[0];
      walletEl.textContent = currentAccount;
      mintBtn.disabled = false;
      freeMintBtn.disabled = false;
      connectBtn.textContent = "CONNECTED";
    }
  }

  function setupProviderListeners(provider) {
    if (!provider || !provider.on) return;

    provider.on("accountsChanged", (accs) => {
      handleAccountsChanged(accs);
    });

    provider.on("chainChanged", (chainId) => {
      const hex = String(chainId).toLowerCase();
      if (hex !== MONAD_CHAIN_ID_HEX.toLowerCase()) {
        setStatus("WRONG NETWORK – SELECT MONAD (143)", "error");
      } else {
        setStatus("", "");
      }
    });
  }

  function parseFriendlyError(err) {
    const nested =
      err?.data?.message ||
      err?.error?.message ||
      err?.message ||
      "";

    let friendly = nested || "";

    if (nested.includes("Not eligible"))                     friendly = "NOT WHITELISTED / NO FREE MINT";
    if (nested.includes("not for sale yet"))                 friendly = "MINT NOT LIVE YET";
    if (nested.includes("Not enough tokens left to mint"))   friendly = "NOT ENOUGH SUPPLY LEFT";
    if (nested.includes("Not enough tokens available"))      friendly = "SOLD OUT";
    if (nested.includes("max NFT per address exceeded"))     friendly = "PER-WALLET LIMIT HIT";
    if (nested.includes("Value below price"))                friendly = "NOT ENOUGH MON SENT";
    if (nested.includes("mint more than the 11"))            friendly = "MAX 11 PER TX";

    if (!friendly) friendly = "MINT FAILED";
    return friendly;
  }

  async function getCurrentChainIdHex(provider) {
    const raw = await provider.request({ method: "eth_chainId" });

    if (typeof raw === "string") {
      if (raw.startsWith("0x") || raw.startsWith("0X")) return raw.toLowerCase();
      const num = Number(raw);
      if (!Number.isNaN(num)) return "0x" + num.toString(16);
      return raw.toLowerCase();
    }

    if (typeof raw === "number") {
      return "0x" + raw.toString(16);
    }

    return String(raw).toLowerCase();
  }

  // Always try to get onto Monad (143)
  async function ensureMonadNetwork(provider) {
    const p = provider || getActiveProvider();
    if (!p) throw new Error("NO WALLET DETECTED");

    let currentHex;
    try {
      currentHex = await getCurrentChainIdHex(p);
    } catch (e) {
      console.error("Failed to read chainId", e);
      // If we can't read chainId we just bail and let the wallet handle it
      return;
    }

    // Already on Monad
    if (currentHex === MONAD_CHAIN_ID_HEX.toLowerCase()) {
      return;
    }

    try {
      // Ask wallet to switch to Monad (chain 143)
      await p.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: MONAD_CHAIN_ID_HEX }]
      });
    } catch (switchError) {
      // Chain not added yet → try to add it
      if (
        switchError.code === 4902 ||
        (typeof switchError.message === "string" &&
         switchError.message.includes("Unrecognized chain ID"))
      ) {
        try {
          await p.request({
            method: "wallet_addEthereumChain",
            params: [MONAD_PARAMS]
          });
        } catch (addError) {
          console.error("wallet_addEthereumChain failed", addError);
          throw new Error("Please add Monad (chain 143) in your wallet, then try again.");
        }
      } else {
        console.error("wallet_switchEthereumChain failed", switchError);
        throw new Error("Please switch to Monad (chain 143) in your wallet, then try again.");
      }
    }
  }

  // ====== ASCII MINT STATS ======
  function renderMintStats(minted, max) {
    mintedTextEl.textContent = ">" + minted + "/" + max + " MINTED";

    const ratio  = Math.max(0, Math.min(1, minted / max));
    const filled = Math.round(ratio * BAR_LENGTH);
    const fillChars = "/".repeat(filled > 0 ? filled : 0);
    const dotChars  = ".".repeat(Math.max(0, BAR_LENGTH - filled));
    barTextEl.textContent = ">[" + fillChars + dotChars + "]";
  }

  async function refreshMintStats() {
    try {
      const provider = new ethers.providers.JsonRpcProvider("https://rpc.monad.xyz");
      const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);

      const supplyBN = await contract.totalSupply();
      const maxBN    = await contract.maxSupply().catch(() => ethers.BigNumber.from(MINT_MAX_FALLBACK));

      const minted = supplyBN.toNumber();
      const max    = maxBN.toNumber();

      renderMintStats(minted, max);
    } catch (e) {
      console.error("Failed to refresh mint stats", e);
      renderMintStats(0, MINT_MAX_FALLBACK);
    }
  }

  // run once on load
  refreshMintStats();

  // ====== CONNECT BUTTON ======
  async function connectWallet() {
    try {
      // 1) Try injected (MetaMask / Trust / Phantom, etc.)
      injectedProvider = detectInjectedProvider();

      if (injectedProvider) {
        const provider = injectedProvider;
        activeProvider = provider;

        if (isPhantomMobile()) {
          alert(
            "PHANTOM MOBILE DETECTED\n\n" +
            "To mint on Monad with Phantom mobile:\n\n" +
            "1. Open Phantom → Settings → Active Networks.\n" +
            "2. ENABLE Monad network.\n" +
            "3. DISABLE every other EVM network (Ethereum, Base, etc.).\n" +
            "4. Restart the app, come back here and press CONNECT / MINT again.\n\n" +
            "If other EVM chains stay enabled or Monad is disabled, Phantom " +
            "may send the tx on the wrong chain or block it."
          );
        }

        const accs = await provider.request({
          method: "eth_requestAccounts"
        });
        handleAccountsChanged(accs);
        setupProviderListeners(provider);

        await ensureMonadNetwork(provider);

        setStatus("CONNECTED", "success");
      } else {
        // 2) Fallback → WalletConnect (mobile normal browser etc.)
        setStatus("OPENING WALLETCONNECT…", "info");

        const wc = await getWalletConnectProvider();
        const wcAccounts = await wc.enable(); // opens QR / app selector

        if (!wcAccounts || !wcAccounts.length) {
          throw new Error("NO ACCOUNT SELECTED IN WALLET");
        }

        activeProvider = wc;
        handleAccountsChanged(wcAccounts);
        setupProviderListeners(wc);
        connectBtn.textContent = "CONNECTED (WC)";
        setStatus("CONNECTED VIA WALLETCONNECT", "success");
      }

      // Try to read on-chain cost using whichever provider is active
      try {
        const web3Provider = new ethers.providers.Web3Provider(getActiveProvider(), "any");
        const contract     = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, web3Provider);
        const onChainCost  = await contract.cost();
        if (onChainCost.gt(0)) {
          costWei = onChainCost;
          updatePrice();
        }
      } catch (e) {
        // ignore, keep fallback cost
      }
    } catch (err) {
      console.error(err);
      setStatus(err.message || "FAILED TO CONNECT", "error");
    }
  }

  connectBtn.addEventListener("click", connectWallet);

  // ====== PAID MINT ======
  async function mint() {
    const provider = getActiveProvider();
    if (!provider) { setStatus("NO WALLET DETECTED", "error"); return; }
    if (!currentAccount) { setStatus("CONNECT FIRST", "error"); return; }

    try {
      await ensureMonadNetwork(provider);

      const web3Provider = new ethers.providers.Web3Provider(provider, "any");
      const signer   = web3Provider.getSigner();
      const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

      const value = costWei.mul(amount);

      setStatus("SENDING TRANSACTION…");
      mintBtn.disabled = true;
      freeMintBtn.disabled = true;

      const tx = await contract.mint(amount, { value });
      setStatus("WAITING FOR CONFIRMATION…");
      await tx.wait();

      setStatus("MINT SUCCESSFUL", "success");
      mintBtn.disabled = false;
      freeMintBtn.disabled = false;

      refreshMintStats();
    } catch (err) {
      console.error(err);
      mintBtn.disabled = false;
      freeMintBtn.disabled = false;
      if (err.code === 4001) {
        setStatus("TX REJECTED BY USER", "error");
      } else {
        setStatus(parseFriendlyError(err), "error");
      }
    }
  }

  mintBtn.addEventListener("click", mint);

  // ====== FREE MINT ======
  async function freeMint() {
    const provider = getActiveProvider();
    if (!provider) { setStatus("NO WALLET DETECTED", "error"); return; }
    if (!currentAccount) { setStatus("CONNECT FIRST", "error"); return; }

    try {
      await ensureMonadNetwork(provider);

      const web3Provider = new ethers.providers.Web3Provider(provider, "any");
      const signer   = web3Provider.getSigner();
      const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

      setStatus("SENDING FREE MINT TX…");
      mintBtn.disabled = true;
      freeMintBtn.disabled = true;

      const tx = await contract.freeMint();
      setStatus("WAITING FOR CONFIRMATION…");
      await tx.wait();

      setStatus("FREE MINT SUCCESSFUL", "success");
      mintBtn.disabled = false;
      freeMintBtn.disabled = false;

      refreshMintStats();
    } catch (err) {
      console.error(err);
      mintBtn.disabled = false;
      freeMintBtn.disabled = false;
      if (err.code === 4001) {
        setStatus("TX REJECTED BY USER", "error");
      } else {
        setStatus(parseFriendlyError(err), "error");
      }
    }
  }

  freeMintBtn.addEventListener("click", freeMint);

  // ====== NFT PREVIEW SLIDESHOW ======
  const prerevealSrc = "nft_prereveal.png"; // default image
  const nftImages = [
      "nfts/10.png",
        "nfts/1013.png",
        "nfts/1017.png",
        "nfts/1019.png",
        "nfts/1085.png",
        "nfts/1101.png",
        "nfts/1107.png",
        "nfts/137.png",
        "nfts/184.png",
        "nfts/186.png",
        "nfts/191.png",
        "nfts/2.png",
        "nfts/240.png",
        "nfts/352.png",
        "nfts/423.png",
        "nfts/439.png",
        "nfts/469.png",
        "nfts/474.png",
        "nfts/516.png",
        "nfts/567.png",
        "nfts/570.png",
        "nfts/630.png",
        "nfts/70.png",
        "nfts/711.png",
        "nfts/712.png",
        "nfts/784.png",
        "nfts/787.png",
        "nfts/839.png",
        "nfts/857.png",
        "nfts/858.png",
        "nfts/930.png",
        "nfts/934.png",
        "nfts/961.png",
        "nfts/985.png"  ];

  const previewWindow = document.getElementById("nftPreviewWindow");
  const previewInner  = document.getElementById("nftPreviewInner");
  const previewImg    = document.getElementById("nftPreview");

  let currentPreviewSrc = prerevealSrc;

  function pickRandomNft() {
    if (!nftImages.length) return prerevealSrc;
    let next = nftImages[Math.floor(Math.random() * nftImages.length)];
    if (next === currentPreviewSrc && nftImages.length > 1) {
      let tries = 0;
      while (next === currentPreviewSrc && tries < 6) {
        next = nftImages[Math.floor(Math.random() * nftImages.length)];
        tries++;
      }
    }
    return next;
  }

  function showRandomPreview() {
    const newSrc = pickRandomNft();
    if (newSrc === currentPreviewSrc) return;

    previewInner.classList.add("dissolve");

    setTimeout(() => {
      previewImg.src = newSrc;
      currentPreviewSrc = newSrc;
      previewInner.classList.remove("dissolve");
    }, 180);
  }

  function resetToPrereveal() {
    if (currentPreviewSrc === prerevealSrc) return;
    previewInner.classList.add("dissolve");
    setTimeout(() => {
      previewImg.src = prerevealSrc;
      currentPreviewSrc = prerevealSrc;
      previewInner.classList.remove("dissolve");
    }, 180);
  }

  // Desktop hover
  previewWindow.addEventListener("mouseenter", showRandomPreview);
  previewWindow.addEventListener("mouseleave", resetToPrereveal);

  // Mobile tap toggle
  previewWindow.addEventListener("click", (e) => {
    e.preventDefault();
    if (currentPreviewSrc === prerevealSrc) {
      showRandomPreview();
    } else {
      resetToPrereveal();
    }
  });
</script>
</body>
</html>
